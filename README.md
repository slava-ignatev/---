# -_-
SQL-решение для расчета доли валютных клиентов и комиссии платежей

**ЗАДАНИЕ 1.**
Написать SQL-запрос на любом диалекте или код на Python, который вычисляет долю клиентов с валютными счетами в динамике на каждое первое число месяца.  
Исходные данные:
1. Таблица ACCOUNTS
2. Таблица CALENDAR
* если у клиента есть валютный счет, значит, обязательно есть и рублевый.
** у клиента одновременно может быть несколько рублевых и несколько валютных счетов
  Решение

Использован [SQL-запрос]([https://github.com/slava-ignatev/---/blob/99bd4b8aa42bb8077bdd072c34f36c2116dc9b0b/%D0%9F%D0%B5%D1%80%D0%B2%D0%BE%D0%B5%20%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5.sql) в котором:
- присоединяем к календарю таблицу с клиентами
- джойним даты открытия и закрытия с календарной датой, учитываем активные счета (NULL). Дата открытия должна быть раньше или равна календарной дате, а дата закрытия быть позднее
- извлекаем только первое число месяца из календарной даты
- считаем уникальное количество клиентов с активными счетами и уникальное количество клиентов с валютными счетами
- в общем запросе делим валютных клиентов на общее количество клиентов, чтобы рассчитать долю. Добавляем период

 
**ЗАДАНИЕ 2.**
Написать SQL-запрос, который для каждого платежа определяет комиссию, которую клиент должен оплатить при совершении платежа. До 400 000 рублей в месяц без комисии, превышение сверх лимита - по 2000 рублей за каждые 100 000 рублей в рамках месяца
 
Исходные данные:
1. Таблица PAYMENTS – данные об исходящих платежах клиентов

Использован [SQL-запрос](https://github.com/slava-ignatev/---/blob/b98fcd89b12678a7b9b2eb7129886111e22ae109/%D0%92%D1%82%D0%BE%D1%80%D0%BE%D0%B5%20%D0%B7%D0%B0%D0%B4%D0%B0%D0%BD%D0%B8%D0%B5.sql) в котором:
- сделано две CTE c оконными фукнциями
- в первом случае используем оконную функцию с суммированием платежей в рамках клиента и месяца платежа, сортируем по дате платежа, чтобы посчитать накопительный итог
- во втором случае используем оконную функцию смещения, которая возвращает значение накопленного платежа из предыдущей строки, аналогично по каждому клиенту и месяцу, сортируем по дате платежа. Это решение нужно, чтобы учитывать активную комиссию при новом платеже.
- в основном запросе используем данные из второй CTE и оператор CASE

Логика оператора CASE:  
Если накопленная сумма ≤ 400,000, комиссия = 0
Если превышение есть, вычисляем:
   - Текущее количество пакетов: CEILING((running_total - 400000) / 100000) - считаем разницу накопленной суммы от лимита, делим на размер пакета, округляем вверх
   - Предыдущее количество пакетов: CEILING((prev_running_total - 400000) / 100000) считаем разницу предыдущей накопленной суммы от лимита, делим на размер пакета, округляем вверх
   - Комиссия = (текущие пакеты - предыдущие пакеты) × 2000 руб. 
